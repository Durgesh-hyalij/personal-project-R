<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Report History | Project-R</title>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<style>
/* ===============================
    MODERN REFRESH & VARIABLES
================================ */
:root {
  --primary: #2563eb;
  --primary-dark: #1e40af;
  --bg-gray: #f8fafc;
  --text-main: #1e293b;
  --text-muted: #64748b;
  --white: #ffffff;
  --border: #e2e8f0;
  --danger: #ef4444;
}

body {
  margin: 0;
  font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
  background: var(--bg-gray);
  color: var(--text-main);
  overflow: hidden; /* Prevent double scrollbars */
}

/* ===============================
    MODERN NAVBAR
================================ */
.topbar {
  height: 64px;
  background: var(--white);
  color: var(--text-main);
  display: flex;
  align-items: center;
  padding: 0 30px;
  border-bottom: 1px solid var(--border);
  box-shadow: 0 1px 3px rgba(0,0,0,0.05);
  position: sticky;
  top: 0;
  z-index: 100;
}

.topbar h3 {
  margin: 0;
  font-size: 1.25rem;
  font-weight: 700;
  color: var(--primary);
  letter-spacing: -0.5px;
}

.topbar .right {
  margin-left: auto;
  display: flex;
  align-items: center;
  gap: 12px;
}

/* Navbar Buttons */
.topbar a, .topbar button {
  text-decoration: none;
  font-size: 14px;
  font-weight: 600;
  padding: 8px 16px;
  border-radius: 8px;
  transition: all 0.2s;
  cursor: pointer;
  border: 1px solid transparent;
}

.topbar a {
  color: var(--text-muted);
}

.topbar a:hover {
  color: var(--primary);
  background: #eff6ff;
}

#downloadAiPdf {
  background: #eff6ff;
  color: var(--primary);
  border: 1px solid #dbeafe;
}

#downloadAiPdf:hover {
  background: var(--primary);
  color: white;
}

#shareBtn {
  background: var(--primary);
  color: white;
}

#shareBtn:hover {
  background: var(--primary-dark);
}

#logoutBtn {
  background: transparent;
  color: var(--danger);
  border: 1px solid #fee2e2;
}

#logoutBtn:hover {
  background: #fee2e2;
}

/* ===============================
    MAIN LAYOUT
================================ */
.layout {
  display: flex;
  height: calc(100vh - 65px);
}

/* ===============================
    SIDEBAR
================================ */
.sidebar {
  width: 320px;
  background: var(--white);
  border-right: 1px solid var(--border);
  padding: 20px;
  overflow-y: auto;
}

.sidebar h3 {
  font-size: 0.9rem;
  text-transform: uppercase;
  color: var(--text-muted);
  letter-spacing: 1px;
  margin-bottom: 20px;
}

.report-item {
  background: var(--white);
  padding: 15px;
  margin-bottom: 10px;
  border-radius: 10px;
  cursor: pointer;
  border: 1px solid var(--border);
  transition: all 0.2s;
}

.report-item:hover {
  border-color: var(--primary);
  transform: translateY(-2px);
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}

.report-item.active {
  background: #f0f7ff;
  border-color: var(--primary);
  box-shadow: inset 4px 0 0 var(--primary);
}

.report-item strong {
  display: block;
  color: var(--text-main);
  margin-bottom: 4px;
}

.report-item small {
  color: var(--text-muted);
}

/* ===============================
    CONTENT PANELS
================================ */
.panel {
  flex: 1;
  padding: 30px;
  overflow-y: auto;
  max-width: 900px;
  margin: 0 auto;
}

.content-box {
  background: var(--white);
  padding: 24px;
  border-radius: 12px;
  border: 1px solid var(--border);
  line-height: 1.6;
  box-shadow: 0 1px 2px rgba(0,0,0,0.05);
  margin-bottom: 20px;
}

/* PDF Section */
#pdfSection {
  display: none;
  background: #f1f5f9;
  border: 1px solid var(--border);
  padding: 12px 20px;
  border-radius: 10px;
  margin-bottom: 25px;
  align-items: center;
  gap: 15px;
}

#pdfSection a {
  font-size: 14px;
  font-weight: 600;
  color: var(--primary);
  text-decoration: none;
}

#deleteReportBtn {
  margin-left: auto;
  color: var(--danger);
  background: none;
  border: 1px solid transparent;
  padding: 5px 10px;
  border-radius: 5px;
  cursor: pointer;
}

#deleteReportBtn:hover {
  background: #fee2e2;
  border-color: #fca5a5;
}

#shareLinkBox {
    margin-top: 15px;
}

.alert-success {
    background: #ecfdf5;
    border: 1px solid #10b981;
    color: #065f46;
    padding: 15px;
    border-radius: 8px;
}

/* Toggle Button */
#toggleExtractedBtn {
  display: block;
  width: 100%;
  padding: 12px;
  background: var(--white);
  border: 1px dashed var(--text-muted);
  color: var(--text-muted);
  border-radius: 8px;
  cursor: pointer;
  margin: 20px 0;
  font-weight: 500;
}

#toggleExtractedBtn:hover {
  background: var(--bg-gray);
  color: var(--primary);
}
</style>
</head>

<body>

<script>
  if (!localStorage.getItem("token")) {
    window.location.href = "login.html";
  }
</script>

<div class="topbar">
  <h3>ðŸ©º Project-R</h3>
  <div class="right">
    <a href="index.html">Home</a>
    <button id="downloadAiPdf">Download AI PDF</button>
    <button id="shareBtn">Share With Doctor</button>
    <button id="logoutBtn">Logout</button>
  </div>
</div>

<div class="layout">
  <div class="sidebar" id="reportList">
    <h3>History</h3>
    </div>

  <div class="panel">
    
    <div id="shareLinkBox"></div>

    <div id="pdfSection">
      <span style="font-size: 20px;">ðŸ“„</span> 
      <strong id="pdfName" style="color: var(--text-main);"></strong>
      <a id="viewPdf" target="_blank">View</a>
      <a id="downloadPdf" download>Download</a>
      <button id="deleteReportBtn">ðŸ—‘ Delete Report</button>
    </div>

    <h3 style="margin-top:0;">AI Summary</h3>
    <div id="aiSummary" class="content-box">
      <span style="color: var(--text-muted)">Select a report from the sidebar to view the analysis.</span>
    </div>

    <button id="toggleExtractedBtn">Show full extracted text</button>

    <h3 id="extractedTitle" style="display:none;">Full Extracted Text</h3>
    <div id="extractedText" class="content-box" style="display:none;"></div>
  </div>
</div>

<script>
/* ... [Existing JS Logic remains exactly as you provided] ... */
// Note: I've kept all your logic. Just ensure your script remains 
// at the bottom or wrapped in DOMContentLoaded.
let currentReportId = null;
let extractedVisible = false;

const reportList = document.getElementById("reportList");
const aiSummaryDiv = document.getElementById("aiSummary");
const extractedTextDiv = document.getElementById("extractedText");
const extractedTitle = document.getElementById("extractedTitle");
const toggleBtn = document.getElementById("toggleExtractedBtn");
const pdfSection = document.getElementById("pdfSection");
const pdfNameSpan = document.getElementById("pdfName");
const viewPdfLink = document.getElementById("viewPdf");
const downloadPdfLink = document.getElementById("downloadPdf");
const deleteBtn = document.getElementById("deleteReportBtn");
const downloadAiBtn = document.getElementById("downloadAiPdf");
const logoutBtn = document.getElementById("logoutBtn");
const shareBtn = document.getElementById("shareBtn");
const shareLinkBox = document.getElementById("shareLinkBox");
const token = localStorage.getItem("token");

shareBtn.addEventListener("click", async () => {
    try {
        const response = await fetch("http://127.0.0.1:5000/share-reports", {
            method: "POST",
            headers: { "Authorization": "Bearer " + token }
        });
        const data = await response.json();
        if (!response.ok) {
            shareLinkBox.innerHTML = `<div style="color:red; padding:10px;">${data.error}</div>`;
            return;
        }
        shareLinkBox.innerHTML = `
            <div class="alert-success">
                <strong>Share Link (Valid 7 days):</strong><br>
                <a href="${data.share_link}" target="_blank" style="word-break: break-all;">${data.share_link}</a>
                <br><br>
                <button style="padding:5px 10px; cursor:pointer;" onclick="copyLink('${data.share_link}')">Copy Link</button>
            </div>`;
    } catch (error) {
        shareLinkBox.innerHTML = `<div style="color:red; padding:10px;">Failed to generate share link.</div>`;
    }
});

function copyLink(link) {
    navigator.clipboard.writeText(link);
    alert("Link copied to clipboard");
}

fetch("http://127.0.0.1:5000/history", {
  headers: { "Authorization": "Bearer " + token }
})
.then(res => {
  if (res.status === 401) {
    localStorage.removeItem("token");
    window.location.href = "login.html";
    return null;
  }
  return res.json();
})
.then(data => {
  if (!data) return;
  data.data.forEach(report => {
    const div = document.createElement("div");
    div.className = "report-item";
    div.innerHTML = `<strong>${report.pdf_name}</strong><small>${report.created_at}</small>`;
    div.onclick = () => loadReport(report.id, div);
    reportList.appendChild(div);
  });
});

function loadReport(id, element) {
  document.querySelectorAll(".report-item").forEach(i => i.classList.remove("active"));
  element.classList.add("active");
  currentReportId = id;

  fetch(`http://127.0.0.1:5000/history/${id}`, {
    headers: { "Authorization": "Bearer " + token }
  })
  .then(res => res.json())
  .then(data => {
    aiSummaryDiv.innerHTML = marked.parse(data.data.ai_summary || "No AI summary available");
    extractedTextDiv.innerHTML = marked.parse(data.data.extracted_text);
    extractedVisible = false;
    extractedTextDiv.style.display = "none";
    extractedTitle.style.display = "none";
    toggleBtn.textContent = "Show full extracted text";
    const pdfUrl = `http://127.0.0.1:5000/download/${data.data.pdf_name}`;
    pdfNameSpan.textContent = data.data.pdf_name;
    viewPdfLink.href = pdfUrl;
    downloadPdfLink.href = pdfUrl;
    pdfSection.style.display = "flex";
  });
}

toggleBtn.addEventListener("click", () => {
  extractedVisible = !extractedVisible;
  extractedTextDiv.style.display = extractedVisible ? "block" : "none";
  extractedTitle.style.display = extractedVisible ? "block" : "none";
  toggleBtn.textContent = extractedVisible ? "Hide full extracted text" : "Show full extracted text";
});

deleteBtn.addEventListener("click", () => {
  if (!currentReportId) return alert("Select a report first");
  if (!confirm("Delete this report permanently?")) return;
  fetch(`http://127.0.0.1:5000/history/${currentReportId}`, {
    method: "DELETE",
    headers: { "Authorization": "Bearer " + token }
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      document.querySelector(".report-item.active")?.remove();
      aiSummaryDiv.textContent = "Select a report to view AI summary";
      pdfSection.style.display = "none";
      currentReportId = null;
    }
  });
});

downloadAiBtn.addEventListener("click", () => {
  const text = aiSummaryDiv.textContent.trim();
  if (!text) return alert("No AI summary available");
  fetch("http://127.0.0.1:5000/generate-pdf", {
    method: "POST",
    headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
    body: JSON.stringify({ result: text })
  })
  .then(res => res.blob())
  .then(blob => {
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "AI_Summary.pdf";
    a.click();
  });
});

logoutBtn.addEventListener("click", () => {
  localStorage.removeItem("token");
  window.location.href = "login.html";
});
</script>

</body>
</html>