<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Report History</title>

<!-- Markdown Parser -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #f4f6f8;
}

/* ---------- TOP NAVBAR ---------- */
.topbar {
  height: 60px;
  background: #0d47a1;
  color: #ffffff;
  display: flex;
  align-items: center;
  padding: 0 20px;
}

.topbar h4 { margin: 0; }
.topbar span { margin-left: 10px; font-size: 14px; opacity: 0.9; }
.topbar .right { margin-left: auto; }
.topbar a {
  color: #fff;
  border: 1px solid #fff;
  padding: 6px 12px;
  border-radius: 6px;
  text-decoration: none;
}
#downloadAiPdf {
  margin-left: 10px;
  background: #fff;
  color: #0d47a1;
  border: none;
  padding: 7px 12px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
}

/* ---------- LAYOUT ---------- */
.layout {
  display: flex;
  height: calc(100vh - 60px);
}

/* ---------- SIDEBAR ---------- */
.sidebar {
  width: 280px;
  background: #f7f9fc;
  border-right: 1px solid #ddd;
  padding: 10px;
  overflow-y: auto;
}
.report-item {
  background: #fff;
  padding: 10px;
  margin-bottom: 8px;
  border-radius: 6px;
  cursor: pointer;
  border: 1px solid #e2e8f0;
}
.report-item:hover { background: #eef4ff; }
.report-item.active {
  background: #dbe9ff;
  border-left: 4px solid #0d47a1;
  font-weight: 600;
}

/* ---------- PANELS ---------- */
.panel {
  flex: 1;
  padding: 15px;
  overflow-y: auto;
}
.content-box {
  background: #fff;
  padding: 12px;
  border-radius: 6px;
  border: 1px solid #ddd;
  white-space: pre-wrap;
}

/* ---------- PDF ACTION BAR ---------- */
#pdfSection {
  display: none;
  background: #fff;
  border: 1px solid #ddd;
  padding: 10px;
  border-radius: 6px;
  margin-bottom: 10px;
  display: flex;
  gap: 15px;
  align-items: center;
}
#deleteReportBtn {
  color: red;
  border: none;
  background: none;
  cursor: pointer;
}

/* ---------- TOGGLE BUTTON ---------- */
#toggleExtractedBtn {
  margin: 10px 0;
  padding: 6px 10px;
  background: #e3f2fd;
  border: 1px solid #90caf9;
  border-radius: 6px;
  cursor: pointer;
}

/* ---------- MARKDOWN ---------- */
.content-box h1, h2, h3 { color: #0d47a1; }
.content-box ul { padding-left: 20px; }
</style>
</head>

<body>

<!-- NAVBAR -->
<div class="topbar">
  <h4>ðŸ©º Project-R</h4>
  <span>[AI-Powered Medical Report Analyzer]</span>

  <div class="right">
    <a href="index.html">Home</a>
    <button id="downloadAiPdf">Download AI PDF</button>
  </div>
</div>

<!-- MAIN -->
<div class="layout">

  <!-- SIDEBAR -->
  <div class="sidebar" id="reportList">
    <h3>Reports</h3>
  </div>

  <!-- CENTER -->
  <div class="panel">

    <div id="pdfSection">
      ðŸ“„ <strong id="pdfName"></strong>
      <a id="viewPdf" target="_blank">View</a>
      <a id="downloadPdf" download>Download</a>
      <button id="deleteReportBtn">ðŸ—‘ Delete</button>
    </div>

    <h3>AI Summary (Important)</h3>
    <div id="aiSummary" class="content-box">
      Select a report to view AI summary
    </div>

    <button id="toggleExtractedBtn">Show full extracted text</button>

    <h3 id="extractedTitle" style="display:none;">Full Extracted Text</h3>
    <div id="extractedText" class="content-box" style="display:none;"></div>
  </div>

</div>

<script>
let currentReportId = null;
let extractedVisible = false;

const reportList = document.getElementById("reportList");
const aiSummaryDiv = document.getElementById("aiSummary");
const extractedTextDiv = document.getElementById("extractedText");
const extractedTitle = document.getElementById("extractedTitle");
const toggleBtn = document.getElementById("toggleExtractedBtn");

const pdfSection = document.getElementById("pdfSection");
const pdfNameSpan = document.getElementById("pdfName");
const viewPdfLink = document.getElementById("viewPdf");
const downloadPdfLink = document.getElementById("downloadPdf");
const deleteBtn = document.getElementById("deleteReportBtn");
const downloadAiBtn = document.getElementById("downloadAiPdf");

/* LOAD HISTORY */
fetch("http://127.0.0.1:5000/history")
  .then(res => res.json())
  .then(data => {
    data.data.forEach(report => {
      const div = document.createElement("div");
      div.className = "report-item";
      div.innerHTML = `<strong>${report.pdf_name}</strong><br><small>${report.created_at}</small>`;
      div.onclick = () => loadReport(report.id, div);
      reportList.appendChild(div);
    });
  });

/* LOAD REPORT */
function loadReport(id, element) {
  document.querySelectorAll(".report-item").forEach(i => i.classList.remove("active"));
  element.classList.add("active");
  currentReportId = id;

  fetch(`http://127.0.0.1:5000/history/${id}`)
    .then(res => res.json())
    .then(data => {
      aiSummaryDiv.innerHTML = marked.parse(data.data.ai_summary || "No AI summary available");
      extractedTextDiv.innerHTML = marked.parse(data.data.extracted_text);

      extractedVisible = false;
      extractedTextDiv.style.display = "none";
      extractedTitle.style.display = "none";
      toggleBtn.textContent = "Show full extracted text";

      const pdfUrl = `http://127.0.0.1:5000/download/${data.data.pdf_name}`;
      pdfNameSpan.textContent = data.data.pdf_name;
      viewPdfLink.href = pdfUrl;
      downloadPdfLink.href = pdfUrl;
      pdfSection.style.display = "flex";
    });
}

/* TOGGLE EXTRACTED TEXT */
toggleBtn.addEventListener("click", () => {
  extractedVisible = !extractedVisible;
  extractedTextDiv.style.display = extractedVisible ? "block" : "none";
  extractedTitle.style.display = extractedVisible ? "block" : "none";
  toggleBtn.textContent = extractedVisible ? "Hide full extracted text" : "Show full extracted text";
});

/* DELETE REPORT */
deleteBtn.addEventListener("click", () => {
  if (!currentReportId) return alert("Select a report first");
  if (!confirm("Delete this report permanently?")) return;

  fetch(`http://127.0.0.1:5000/history/${currentReportId}`, { method: "DELETE" })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        document.querySelector(".report-item.active")?.remove();
        aiSummaryDiv.textContent = "Select a report to view AI summary";
        extractedTextDiv.style.display = "none";
        pdfSection.style.display = "none";
        currentReportId = null;
      } else alert(data.message);
    });
});

/* DOWNLOAD AI PDF */
downloadAiBtn.addEventListener("click", () => {
  const text = aiSummaryDiv.textContent.trim();
  if (!text) return alert("No AI summary");

  fetch("http://127.0.0.1:5000/generate-pdf", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ result: text })
  })
  .then(res => res.blob())
  .then(blob => {
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "AI_Summary.pdf";
    a.click();
  });
});
</script>

</body>
</html>
